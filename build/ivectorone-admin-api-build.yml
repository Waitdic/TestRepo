trigger:
  branches:
    include:
    - main
  paths:
    include:
    - src/iVectorOne-Admin-Api

pool:
  vmImage: 'windows-latest'

variables:
  project: 'iVectorOne-Admin-Api'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  appVersion: '10.9.8.7'

steps:

- task: Assembly-Info-NetCore@3
  displayName: 'Set Assembly Metadata'
  inputs:
    Path: '$(Build.SourcesDirectory)/src/$(project)'
    FileNames: '**/*.csproj'
    InsertAttributes: false
    FileEncoding: 'auto'
    WriteBOM: false
    LogLevel: 'normal'
    FailOnWarning: false
    DisableTelemetry: false
    Company: 'Intuitive Systems'
    Product: 'iVectorOne Admin Api'
    Description: 'iVectorOne Admin Api'
    Copyright: 'Copyright Â© $(date:YYYY) Example Ltd'
    Culture: 'en-GB'
    VersionNumber: '$(appVersion)'
    FileVersionNumber: '$(appVersion)'
    InformationalVersion: '$(appVersion)'
    PackageVersion: '$(appVersion)'
    IgnoreNetFrameworkProjects: false
    UpdateBuildNumber: '$(Build.DefinitionName)_$(appVersion)'
    AddBuildTag: 'v$(appVersion)'

- task: SonarCloudPrepare@1
  inputs:
    SonarCloud: 'SonarCloud'
    organization: 'intuitive-systems'
    scannerMode: 'MSBuild'
    projectKey: 'Intuitive_iVectorOne_Admin_Api'
    projectName: 'iVectorOne Admin Api'

- task: DotNetCoreCLI@2
  displayName: 'Build'
  inputs:
    command: 'build'
    projects: 'src/$(project)/**/*.csproj'
    arguments: '-c $(buildConfiguration) -o $(build.artifactStagingDirectory)'


- task: DotNetCoreCLI@2
  displayName: 'Unit Tests'
  inputs:
    command: 'test'
    projects: 'test/$(project)**/*.csproj'
    arguments: '-c $(buildConfiguration)'
    testRunTitle: 'Unit Tests'

- task: SonarCloudAnalyze@1

- task: SonarCloudPublish@1
  inputs:
    pollingTimeoutSec: '300'
    
- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: 'src/$(project)/**/*.csproj'
    arguments: '-c $(buildConfiguration) -o $(build.artifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'
