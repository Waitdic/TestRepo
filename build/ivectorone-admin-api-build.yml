trigger:
  branches:
    include:
    - main
  paths:
    include:
    - src/iVectorOne-Admin-Api

pool:
  vmImage: 'windows-latest'

variables:
  project: 'iVectorOne-Admin-Api'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:
- task: PowerShell@2
  displayName: 'Create version number'
  inputs:
    targetType: 'inline'
    script: |
      $Year = (Get-Date).Year.ToString().SubString(2, 2)
      $DayOfYear = (Get-Date).DayOfYear
      $TotalMinutes = - [Math]::Truncate(((Get-Date -Hour 0 -Minute 0 -Second 0) - (Get-Date)).TotalMinutes)

      $Major = $Year + $DayOfYear
      $Minor = 0
      $Build = $TotalMinutes

      $buildNumber = $Major + '.' + $Minor + '.' + $Build + '.' + $(Build.BuildId)
      $pattern = '\[assembly: AssemblyVersion\("(.*)"\)\]'
      $AssemblyFiles = Get-ChildItem . AssemblyInfo.cs -rec

      foreach ($file in $AssemblyFiles)
      {
        (Get-Content $file.PSPath) | ForEach-Object{
            if($_ -match $pattern){
                '[assembly: AssemblyVersion("{0}")]' -f $buildNumber
            } else {
                # Output line as is
                $_
            }
      } | Set-Content $file.PSPath
      }


- task: SonarCloudPrepare@1
  inputs:
    SonarCloud: 'SonarCloud'
    organization: 'intuitive-systems'
    scannerMode: 'MSBuild'
    projectKey: 'Intuitive_iVectorOne_Admin_Api'
    projectName: 'iVectorOne Admin Api'

- task: DotNetCoreCLI@2
  displayName: 'Build'
  inputs:
    command: 'build'
    projects: 'src/$(project)/**/*.csproj'
    arguments: '-c $(buildConfiguration) -o $(build.artifactStagingDirectory)'


- task: DotNetCoreCLI@2
  displayName: 'Unit Tests'
  inputs:
    command: 'test'
    projects: 'test/$(project)**/*.csproj'
    arguments: '-c $(buildConfiguration)'
    testRunTitle: 'Unit Tests'

- task: SonarCloudAnalyze@1

- task: SonarCloudPublish@1
  inputs:
    pollingTimeoutSec: '300'
    
- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: 'src/$(project)/**/*.csproj'
    arguments: '-c $(buildConfiguration) -o $(build.artifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'
