# Build, test and deploy iVectorOne Search API

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - src/iVectorOne-Search-Api
    - tests/iVectorOne-Search-Api-BuildTests

parameters:
- name: deploy
  displayName: Deploy to Production?
  type: boolean
  default: false

pool:
  vmImage: ubuntu-latest

stages:
- stage: Tests
  jobs:
  - job:
    displayName: Unit tests
    steps:
    - script: echo simulate running your unit tests!
      displayName: 'Run unit tests'
  - job: 
    displayName: UI tests
    steps:
    - script:  echo simulate running your ui tests!
      displayName: 'Run unit tests'

- stage: Build
  dependsOn: [] # This will remove implicit dependency and run in parallel with the stage: Tests above 
  jobs:
  - job:
    displayName: Build the application
    steps:
    - script: |
        echo Running all builds commands...
        echo ... commands successfully completed.
      displayName: 'Run build scripts & tasks'

- stage: Staging
  dependsOn:
  - Tests
  - Build
  jobs:
  - deployment:
    displayName: Staging deploy
    environment: Staging
    strategy:
     runOnce:
       deploy:
         steps:
           - script: echo Running in the Staging environment as deployment job
             displayName: 'Staging based stage'


- stage: ProductionCanary
  jobs:
  - deployment: 
    displayName: Production Canary deploy
    environment: ProductionCanary
    strategy:
     runOnce:
       deploy:
         steps:
           - script: echo Running in the Production environment as deployment job
             displayName: 'Production based stage'

- stage: Production
  jobs:
  - deployment: 
    displayName: Production deploy
    environment: Production
    strategy:
     runOnce:
       deploy:
         steps:
           - script: echo Running in the Production environment as deployment job
             displayName: 'Production based stage'